# mkctl Cookbook

Quick reference guide for the most common `mkctl` commands and patterns. Use this as a daily reference when working with mkolbol topologies.

## Quick Start

**What is mkctl?**
`mkctl` is the Microkernel Control CLI—a lightweight tool to run topologies and discover running modules without writing code.

**Installation:**
```bash
npm install -g mkolbol
# or use npx
npx mkctl
```

---

## Running Topologies

### Basic: Run a topology for default duration

```bash
mkctl run --file examples/configs/basic.yml
```

**What happens:**
- Loads YAML/JSON config from file
- Instantiates all modules
- Runs for **5 seconds** (default)
- Logs to stdout
- Cleans up and exits

### Run with custom duration

```bash
mkctl run --file examples/configs/basic.yml --duration 10
```

- `--duration 10` = run for 10 seconds
- Useful for longer-running demos or data processing

### Run from absolute path

```bash
mkctl run --file /path/to/topology.yml --duration 5
```

Always works, regardless of current working directory.

### Stop early with Ctrl+C

```bash
mkctl run --file examples/configs/basic.yml
# Press Ctrl+C to interrupt and shutdown gracefully
```

Output:
```
Topology running for 5 seconds...

Received SIGINT. Shutting down...
Bringing topology down...
Done.
```

---

## Discovering Endpoints

### List all running endpoints

```bash
mkctl endpoints
```

**Output:**
```
Registered Endpoints (RoutingServer snapshot)

ID:          localhost:timer1:0x0001:system:no:none:…
Type:        inproc
Coordinates: node:timer1
Metadata:    {"module":"TimerSource","runMode":"inproc"}
Announced:   2025-10-16T02:45:05.123Z
Updated:     2025-10-16T02:45:05.123Z
```

**What each field means:**
- **ID**: Stable identity generated by Hostess/Executor
- **Type**: Module category (`inproc`, `worker`, `process`, ...)
- **Coordinates**: Where the endpoint lives (`node:<id>`, `worker:<id>`, etc.)
- **Metadata**: Module-specific hints (module name, run mode, command)
- **Announced/Updated**: Timestamps from the RoutingServer

### Query endpoints while a topology is running

```bash
# Terminal 1: Start topology
mkctl run --file examples/configs/external-pty.yaml --duration 60

# Terminal 2: Inspect routing snapshot
mkctl endpoints
```

Whenever `mkctl run` exits it persists a snapshot to `reports/router-endpoints.json`. `mkctl endpoints` will fall back to the Hostess snapshot (`reports/endpoints.json`) if no router snapshot exists yet.

---

## Common Topologies

### PTY Demo (Interactive Shell)

```bash
mkctl run --file examples/configs/external-pty.yaml --duration 10
```

Use for interactive shell demos, TTY hijacking, or PTY regression tests.

### StdIO Demo (Data Piping)

```bash
mkctl run --file examples/configs/external-stdio.yaml --duration 5
```

Use for non-interactive filters, streaming pipelines, or quick performance checks.

### HTTP Logs Demo (Local Node v1.0)

```bash
export MK_LOCAL_NODE=1
mkctl run --file examples/configs/http-logs-local.yml --duration 10
```

**In another terminal, send requests:**
```bash
curl -s http://localhost:3000/hello
curl -s http://localhost:3000/test
```

This demonstrates:
- ExternalProcess (HTTP server) → ConsoleSink (console output)
- RoutingServer endpoint discovery and lifecycle
- Local Node in-process routing
- Using `--watch` to monitor endpoints while topology runs

See **[Local Node v1.0 Demo](./quickstart.md#local-node-v10-demo-http-to-console)** for full walkthrough.

### Custom Config

```bash
mkctl run --file my-topology.yml --duration 5
```

Minimal topology:

```yaml
nodes:
  - id: source
    module: TimerSource
    params: { periodMs: 1000 }
  - id: sink
    module: ConsoleSink
    params: { prefix: "[demo]" }

connections:
  - from: source.output
    to: sink.input
```

---

## Troubleshooting Cheatsheet

| Symptom | Fix |
|---------|-----|
| `Config file not found` | Verify the path, or run `mkctl run --file $(pwd)/examples/configs/basic.yml`. |
| `Failed to read config` | Validate YAML/JSON syntax (`python -m yaml …`), ensure `nodes` and `connections` arrays exist. |
| `Topology runtime error` | Confirm module names exist (registered in `ModuleRegistry`) and external commands reside on `$PATH`. |
| `No endpoints registered` | Run `mkctl run` first—the router snapshot is generated at shutdown. |
| `mkctl: command not found` | Use `npx mkctl …` or `node dist/scripts/mkctl.js …`. |

For deeper help see the **Troubleshooting** section in [README.md](../../README.md#mkctl-troubleshooting).

---

## Exit Codes Reference

mkctl uses standard exit codes to indicate success or failure:

| Exit Code | Name | Meaning | Example |
|-----------|------|---------|---------|
| `0` | SUCCESS | Command completed successfully | `mkctl run` finished without errors |
| `64` | USAGE | Invalid command-line arguments | Missing required `--file` option |
| `65` | CONFIG_PARSE | Configuration file has errors | Invalid YAML syntax or missing required fields |
| `66` | CONFIG_NOT_FOUND | Configuration file doesn't exist | Path to config file is wrong |
| `70` | RUNTIME | Error during topology execution | Failed to spawn external process or connection error |
| `130` | INTERRUPTED | Command was interrupted by user | User pressed Ctrl+C during topology run |

### Using Exit Codes in Scripts

Exit codes enable automation and CI/CD integration:

```bash
# Check if mkctl run succeeded
mkctl run --file my-config.yml
if [ $? -eq 0 ]; then
  echo "Topology completed successfully"
else
  echo "Topology failed with exit code $?"
fi
```

**Common patterns:**

```bash
# Retry on runtime error (exit code 70)
mkctl run --file config.yml || if [ $? -eq 70 ]; then echo "Retrying..."; fi

# Fail fast on config errors (exit code 65 or 66)
mkctl run --file config.yml || if [ $? -le 66 ]; then exit 1; fi

# Ignore user interruptions (exit code 130)
mkctl run --file config.yml || if [ $? -ne 130 ]; then exit 1; fi
```

---

## Buffer Handling in ConsoleSink

ConsoleSink automatically formats Buffer objects for human-readable console output:

### UTF-8 Text Buffers (≤100 bytes)
```yaml
# Small text buffers are shown as strings
nodes:
  - id: sink
    module: ConsoleSink
```

**Output:**
```
[sink] Buffer(5) "hello"
[sink] Buffer(13) "hello world!\n"
```

### Binary Buffers (≤64 bytes)
```yaml
# Small binary buffers are shown as hex dump
nodes:
  - id: sink
    module: ConsoleSink
```

**Output:**
```
[sink] Buffer(4) [ff 00 ab cd]
[sink] Buffer(8) [de ad be ef ca fe ba be]
```

### Large Buffers (>64 bytes)
```yaml
# Large buffers show first 64 bytes + total size
nodes:
  - id: sink
    module: ConsoleSink
```

**Output:**
```
[sink] Buffer(200) [41 41 41 41 ... +136 bytes]
```

### Empty Buffers
```
[sink] Buffer(0) []
```

**Pro Tip**: ConsoleSink detects printable ASCII/UTF-8 text (including tabs, newlines) and formats accordingly. Binary data triggers hex dump mode.

---

## Error Matrix & Test Fixtures

To help you learn from common mistakes, we provide a set of bad-config fixtures that demonstrate each error. You can test these yourself to understand the error messages and how to fix them.

### Learning with Bad Configs

The `examples/configs/bad-*.yml` files are intentionally broken. Use them to:
1. See what the error message looks like
2. Understand the root cause
3. Learn how to fix it in your own configs

**Test each bad config:**

```bash
# Test invalid YAML syntax
node dist/scripts/mkctl.js run --file examples/configs/bad-invalid-yaml.yml
# Expected: Configuration validation failed: Failed to read config ...

# Test missing nodes array
node dist/scripts/mkctl.js run --file examples/configs/bad-missing-nodes.yml
# Expected: Configuration validation failed: "nodes" must be an array

# Test duplicate node IDs
node dist/scripts/mkctl.js run --file examples/configs/bad-duplicate-ids.yml
# Expected: Configuration validation failed: Duplicate node id 'timer'

# Test connection to non-existent node
node dist/scripts/mkctl.js run --file examples/configs/bad-connection-mismatch.yml
# Expected: Configuration validation failed: Connection from 'source' to non-existent node

# Test invalid command path
node dist/scripts/mkctl.js run --file examples/configs/bad-invalid-command.yml
# Expected: Failed to start topology: Command /nonexistent/bin/jq not found

# Test wrong ioMode (stdio for interactive shell)
node dist/scripts/mkctl.js run --file examples/configs/bad-wrong-iomode.yml
# Expected: Topology running, but bash won't respond to input

# Test missing connections array
node dist/scripts/mkctl.js run --file examples/configs/bad-missing-connections.yml
# Expected: Success (nodes load but don't communicate)

# Test non-existent module
node dist/scripts/mkctl.js run --file examples/configs/bad-invalid-module.yml
# Expected: Configuration validation failed: Unknown module 'NonexistentModule'
```

### Error Message Reference

| Error | Exit Code | Cause | Fix |
|-------|-----------|-------|-----|
| `Config file not found` | 66 | File path wrong or doesn't exist | Check path: `ls -la examples/configs/bad-*.yml` |
| `Failed to read config` | 65 | YAML/JSON syntax error | Validate: `python3 -m yaml examples/configs/bad-invalid-yaml.yml` |
| `"nodes" must be an array` | 65 | Missing or malformed nodes | Add: `nodes: []` with proper indentation |
| `Duplicate node id` | 65 | Same ID used twice | Change one ID to unique name |
| `Connection from '...' to non-existent node` | 70 | Target node doesn't exist | Check node IDs in connections match nodes list |
| `Command ... not found` | 70 | External process path invalid | Use absolute paths: `/bin/bash` not `bash` |
| `Unknown module` | 65 | Module not registered | Check ModuleRegistry for valid names |

### Fixture Overview

```
examples/configs/
├── bad-invalid-yaml.yml           # Broken YAML indentation
├── bad-missing-nodes.yml          # No 'nodes' array
├── bad-duplicate-ids.yml          # Two nodes with same ID
├── bad-connection-mismatch.yml    # Connection to non-existent node
├── bad-invalid-command.yml        # External process path doesn't exist
├── bad-wrong-iomode.yml           # Interactive shell with stdio (not pty)
├── bad-missing-connections.yml    # Nodes defined but no connections
└── bad-invalid-module.yml         # Module name not in registry
```

**Pro Tip**: Compare each bad config to the working examples (basic.yml, external-stdio.yaml, external-pty.yaml) to see what's different. This is a great way to internalize the correct config format!
